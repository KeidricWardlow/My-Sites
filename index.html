<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Factorization</title>
        <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
        <style>
            body {
                font-family: 'Montserrat', sans-serif;
                background: linear-gradient(to right, chartreuse, white);
                margin: 0;
                height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
            }

            .container {
                background: white;
                border: 2px solid black;
                border-radius: 12px;
                padding: 20px;
                text-align: center;
                box-shadow: 5px 5px 0 black;
                width: 95%;
                max-width: 600px;
                height: 90vh;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: flex-start;
                overflow: hidden;
            }

            .toolbar {
                display: flex;
                justify-content: center;
                flex-wrap: wrap;
                gap: 8px;
                margin-bottom: 12px;
            }

            button,
            label.upload {
                background: black;
                color: chartreuse;
                border: none;
                border-radius: 8px;
                padding: 8px 14px;
                font-family: 'Montserrat', sans-serif;
                font-weight: 600;
                cursor: pointer;
                transition: 0.2s;
                font-size: 14px;
            }

            button:hover,
            label.upload:hover {
                background: chartreuse;
                color: black;
            }

            input[type="file"] {
                display: none;
            }

            textarea {
                width: 100%;
                max-width: 500px;
                min-height: 120px;
                border: 2px solid black;
                border-radius: 6px;
                padding: 10px;
                resize: vertical;
                font-size: 15px;
                font-family: 'Montserrat', sans-serif;
            }

            label.option {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                margin: 10px 0;
            }

            #outputContainer {
                margin-top: 12px;
                border: 2px solid black;
                border-radius: 8px;
                padding: 8px;
                text-align: left;
                flex-grow: 1;
                overflow-y: auto;
                width: 100%;
                max-width: 500px;
            }

            .result {
                border-bottom: 1px solid black;
                padding: 6px 0;
            }

            .result:last-child {
                border-bottom: none;
            }

            .factors {
                display: none;
                margin-top: 5px;
                color: black;
                font-weight: 600;
            }

            .toggle {
                background: black;
                color: chartreuse;
                border: none;
                border-radius: 6px;
                padding: 4px 10px;
                cursor: pointer;
                font-size: 13px;
                margin-top: 4px;
            }

            .toggle:hover {
                background: chartreuse;
                color: black;
            }

            @media print {
                body * {
                    visibility: hidden;
                }

                #outputContainer,
                #outputContainer * {
                    visibility: visible;
                }

                #outputContainer {
                    position: absolute;
                    left: 0;
                    top: 0;
                    width: 100%;
                    max-height: none;
                    overflow: visible !important;
                    border: none;
                    box-shadow: none;
                }

                .factors {
                    display: block !important;
                }

                .toggle {
                    display: none !important;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="toolbar">
                <label for="fileInput" class="upload">Choose File</label>
                <input type="file" id="fileInput" accept=".txt,.csv">
                <button onclick="clearAll()">Clear</button>
                <button onclick="exportCSV()">Export CSV</button>
                <button onclick="printPage()">Print</button>
                <button onclick="undo()">Undo</button>
                <button onclick="redo()">Redo</button>
            </div>
            <textarea id="nums" placeholder="Enter numbers (one per line)"></textarea>
            <label class="option">
                <input type="checkbox" id="primeOnly"> Prime only </label>
            <button onclick="factorize()">Factorize</button>
            <div id="outputContainer"></div>
        </div>
        <script>
            let history = [],
                historyIndex = -1;
            const nums = document.getElementById("nums");
            const primeOnlyCheckbox = document.getElementById("primeOnly");
            const outputContainer = document.getElementById("outputContainer");
            window.addEventListener("load", () => {
                const savedNums = localStorage.getItem("nums");
                const savedPrimeOnly = localStorage.getItem("primeOnly");
                const savedHistory = localStorage.getItem("history");
                const savedHistoryIndex = localStorage.getItem("historyIndex");
                const savedToggles = localStorage.getItem("toggles");
                const savedScroll = localStorage.getItem("scrollTop");
                if (savedNums) nums.value = savedNums;
                if (savedPrimeOnly) primeOnlyCheckbox.checked = savedPrimeOnly === "true";
                if (savedHistory) history = JSON.parse(savedHistory);
                if (savedHistoryIndex) historyIndex = parseInt(savedHistoryIndex);
                if (!savedToggles) localStorage.setItem("toggles", "{}");
                if (nums.value.trim()) factorize();
                if (savedScroll) setTimeout(() => {
                    outputContainer.scrollTop = parseInt(savedScroll);
                }, 50);
            });
            nums.addEventListener("input", saveState);
            primeOnlyCheckbox.addEventListener("change", () => {
                saveOptions();
                if (nums.value.trim()) factorize();
            });

            function saveState() {
                if (historyIndex < history.length - 1) history = history.slice(0, historyIndex + 1);
                history.push(nums.value);
                historyIndex = history.length - 1;
                localStorage.setItem("nums", nums.value);
                localStorage.setItem("history", JSON.stringify(history));
                localStorage.setItem("historyIndex", historyIndex);
            }

            function saveOptions() {
                localStorage.setItem("primeOnly", primeOnlyCheckbox.checked);
            }

            function saveOutput() {
                localStorage.setItem("output", outputContainer.innerHTML);
            }

            function saveToggles() {
                const toggles = {};
                outputContainer.querySelectorAll(".result").forEach(div => {
                    const number = div.querySelector("div").textContent;
                    const factorsDiv = div.querySelector(".factors");
                    toggles[number] = factorsDiv.style.display === "block";
                });
                localStorage.setItem("toggles", JSON.stringify(toggles));
            }

            function saveScroll() {
                localStorage.setItem("scrollTop", outputContainer.scrollTop);
            }

            function undo() {
                if (historyIndex > 0) {
                    historyIndex--;
                    nums.value = history[historyIndex];
                    localStorage.setItem("nums", nums.value);
                    localStorage.setItem("historyIndex", historyIndex);
                    factorize();
                }
            }

            function redo() {
                if (historyIndex < history.length - 1) {
                    historyIndex++;
                    nums.value = history[historyIndex];
                    localStorage.setItem("nums", nums.value);
                    localStorage.setItem("historyIndex", historyIndex);
                    factorize();
                }
            }

            function clearAll() {
                nums.value = "";
                outputContainer.innerHTML = "";
                saveState();
                saveOutput();
                localStorage.setItem("toggles", "{}");
                localStorage.setItem("scrollTop", 0);
            }

            function printPage() {
                document.querySelectorAll('.factors').forEach(f => f.style.display = 'block');
                document.querySelectorAll('.toggle').forEach(b => b.textContent = 'Hide');
                window.print();
            }

            function exportCSV() {
                const output = outputContainer.innerText.trim();
                if (!output) return alert("Nothing to export.");
                const blob = new Blob([output], {
                    type: "text/csv"
                });
                const a = document.createElement("a");
                a.href = URL.createObjectURL(blob);
                a.download = "factors.csv";
                a.click();
            }
            document.getElementById("fileInput").addEventListener("change", e => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = ev => {
                    nums.value = ev.target.result;
                    saveState();
                    factorize();
                };
                reader.readAsText(file);
            });

            function primeFactorization(n) {
                const res = [];
                if (n === 1) return [{ p: 1, e: 1 }];
                let num = n;
                for (let p = 2; p * p <= num; p++) {
                    if (num % p === 0) {
                        let e = 0;
                        while (num % p === 0) {
                            num = Math.floor(num / p);
                            e++;
                        }
                        res.push({ p, e });
                    }
                }
                if (num > 1) res.push({ p: num, e: 1 });
                return res;
            }

            function factorize() {
                const lines = nums.value.trim().split(/\n+/);
                const primeOnly = primeOnlyCheckbox.checked;
                const savedToggles = JSON.parse(localStorage.getItem("toggles") || "{}");
                outputContainer.innerHTML = "";
                for (const line of lines) {
                    const trimmed = line.trim();
                    if (!trimmed) continue;
                    const n = parseInt(trimmed);
                    const resultDiv = document.createElement("div");
                    resultDiv.className = "result";
                    if (isNaN(n) || n < 1) {
                        resultDiv.textContent = `Invalid: "${line}"`;
                        outputContainer.appendChild(resultDiv);
                        continue;
                    }

                    const title = document.createElement("div");
                    title.textContent = `${n}`;
                    resultDiv.appendChild(title);

                    const btn = document.createElement("button");
                    btn.className = "toggle";

                    const factorsDiv = document.createElement("div");
                    factorsDiv.className = "factors";

                    if (primeOnly) {
                        if (n === 1) {
                            factorsDiv.innerHTML = "1";
                        } else {
                            const pf = primeFactorization(n);
                            const parts = pf.map(({ p, e }) => {
                                if (e > 1) return `${p}<sup>${e}</sup>`;
                                return `${p}`;
                            });
                            const html = parts.join(" Ã— ");
                            factorsDiv.innerHTML = html;
                            factorsDiv.setAttribute("data-plain", pf.map(({ p, e }) => e > 1 ? `${p}^${e}` : `${p}`).join(" * "));
                        }
                    } else {
                        const divisors = [];
                        for (let i = 1; i <= n; i++) {
                            if (n % i === 0) divisors.push(i);
                        }
                        factorsDiv.textContent = divisors.join(", ");
                    }

                    const expanded = savedToggles[n] || false;
                    factorsDiv.style.display = expanded ? "block" : "none";
                    btn.textContent = expanded ? "Hide" : "Show";
                    btn.onclick = () => {
                        const visible = factorsDiv.style.display === "block";
                        factorsDiv.style.display = visible ? "none" : "block";
                        btn.textContent = visible ? "Show" : "Hide";
                        saveToggles();
                        saveScroll();
                    };
                    resultDiv.appendChild(btn);
                    resultDiv.appendChild(factorsDiv);
                    outputContainer.appendChild(resultDiv);
                }
                saveOutput();
                saveToggles();
                const savedScroll = localStorage.getItem("scrollTop");
                if (savedScroll) outputContainer.scrollTop = parseInt(savedScroll);
                outputContainer.onscroll = saveScroll;
            }

            function isPrime(num) {
                if (num < 2) return false;
                for (let i = 2; i * i <= num; i++) {
                    if (num % i === 0) return false;
                }
                return true;
            }
        </script>
    </body>
</html>
