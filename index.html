<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sequential Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Muli&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Muli', sans-serif;
            background: linear-gradient(to right, navy, teal, white);
            margin: 0;
            padding: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        .controls {
            margin-bottom: 30px;
            text-align: center;
            font-size: 20px;
        }
        select, button {
            margin: 8px;
            padding: 10px 18px;
            font-family: inherit;
            font-size: 18px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: 0.2s ease;
        }
        button:hover {
            background-color: crimson;
            color: white;
        }
        .container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 40px;
            width: 100%;
            max-width: 1200px;
        }
        textarea {
            width: 45%;
            height: 500px;
            padding: 15px;
            font-size: 18px;
            resize: none;
            overflow-x: auto;
            overflow-y: auto;
            white-space: nowrap;
            box-sizing: border-box;
            border-radius: 8px;
            border: 2px solid #333;
        }
        #input {
            background-color: white;
        }
        #output {
            background-color: tan;
        }
        input[type="file"] {
            display: none;
        }
    </style>
</head>
<body>
    <div class="controls">
        <select id="operation">
            <option value="^">^</option>
            <option value="*">*</option>
            <option value="/">/</option>
            <option value="+">+</option>
            <option value="-">-</option>
        </select>
        <button id="upload">Upload File</button>
        <input type="file" id="fileInput" accept=".txt">
        <button id="cut">Cut</button>
        <button id="copy">Copy</button>
        <button id="undo">Undo</button>
        <button id="redo">Redo</button>
        <button id="clear">Clear</button>
        <button id="export">Export CSV</button>
    </div>
    <div class="container">
        <textarea id="input" placeholder="Enter numbers, one per line"></textarea>
        <textarea id="output" readonly></textarea>
    </div>
    <script>
        let history = [];
        let historyIndex = -1;

        function saveState() {
            const state = {
                input: document.getElementById('input').value,
                output: document.getElementById('output').value,
                operation: document.getElementById('operation').value
            };
            history = history.slice(0, historyIndex + 1);
            history.push(state);
            historyIndex++;
            localStorage.setItem('calculatorState', JSON.stringify(state));
        }

        function calculate() {
            const input = document.getElementById('input').value;
            const operation = document.getElementById('operation').value;
            const lines = input.split('\n');
            let output = '';
            for (let line of lines) {
                line = line.trim();
                if (line === '') continue;
                if (!/^\d+$/.test(line)) {
                    output += line + '=Invalid\n';
                    continue;
                }
                const digits = line.split('').map(Number);
                let result;
                switch (operation) {
                    case '^':
                        result = digits.reduceRight((a, b) => Math.pow(b, a));
                        break;
                    case '*':
                        result = digits.reduce((a, b) => a * b, 1);
                        break;
                    case '/':
                        result = digits.reduce((a, b) => a / b);
                        break;
                    case '+':
                        result = digits.reduce((a, b) => a + b, 0);
                        break;
                    case '-':
                        result = digits.reduce((a, b) => a - b);
                        break;
                }
                const expression = digits.join(operation);
                output += `${expression}=${result}\n`;
            }
            document.getElementById('output').value = output.trim();
            saveState();
        }

        window.onload = function() {
            const saved = localStorage.getItem('calculatorState');
            if (saved) {
                const state = JSON.parse(saved);
                document.getElementById('input').value = state.input;
                document.getElementById('output').value = state.output;
                document.getElementById('operation').value = state.operation;
                history = [state];
                historyIndex = 0;
            }
            calculate();
        };

        document.getElementById('input').addEventListener('input', calculate);
        document.getElementById('operation').addEventListener('change', calculate);

        document.getElementById('upload').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    document.getElementById('input').value = e.target.result;
                    calculate();
                };
                reader.readAsText(file);
            }
        });

        document.getElementById('cut').addEventListener('click', () => {
            const output = document.getElementById('output');
            output.select();
            document.execCommand('cut');
        });

        document.getElementById('copy').addEventListener('click', () => {
            const output = document.getElementById('output');
            output.select();
            document.execCommand('copy');
        });

        document.getElementById('undo').addEventListener('click', () => {
            if (historyIndex > 0) {
                historyIndex--;
                const state = history[historyIndex];
                document.getElementById('input').value = state.input;
                document.getElementById('output').value = state.output;
                document.getElementById('operation').value = state.operation;
                localStorage.setItem('calculatorState', JSON.stringify(state));
            }
        });

        document.getElementById('redo').addEventListener('click', () => {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                const state = history[historyIndex];
                document.getElementById('input').value = state.input;
                document.getElementById('output').value = state.output;
                document.getElementById('operation').value = state.operation;
                localStorage.setItem('calculatorState', JSON.stringify(state));
            }
        });

        document.getElementById('clear').addEventListener('click', () => {
            document.getElementById('input').value = '';
            document.getElementById('output').value = '';
            saveState();
        });

        document.getElementById('export').addEventListener('click', () => {
            const output = document.getElementById('output').value;
            const lines = output.split('\n');
            let csv = 'Expression,Result\n';
            for (let line of lines) {
                if (line.includes('=')) {
                    const [expr, res] = line.split('=');
                    csv += expr + ',' + res + '\n';
                }
            }
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'results.csv';
            a.click();
            URL.revokeObjectURL(url);
        });
    </script>
</body>
</html>
