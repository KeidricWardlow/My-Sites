<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>Order Of Operations</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/10.6.4/math.min.js"></script>
        <style>
            body {
                font-family: 'Indie Flower', cursive;
                background-color: fuchsia;
                margin: 0;
                min-height: 100vh;
                display: flex;
                justify-content: center;
                align-items: flex-start;
                padding: 24px;
            }

            .wrapper {
                text-align: center;
                width: 100%;
                max-width: 900px;
            }

            input,
            select,
            button {
                font-family: inherit;
                font-size: 16px;
                margin: 5px;
                padding: 6px 8px;
                border-radius: 8px;
                border: none;
            }

            button {
                cursor: pointer;
                background: white;
            }

            button:hover {
                background-color: cyan;
            }

            .calculations {
                display: flex;
                flex-direction: column;
                gap: 12px;
                margin-top: 12px;
            }

            .calc {
                background: rgba(255, 255, 255, 0.9);
                padding: 12px;
                border-radius: 12px;
                text-align: left;
            }

            .calc-header {
                display: flex;
                align-items: center;
                gap: 8px;
                justify-content: space-between;
            }

            .calc-controls {
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
                justify-content: center;
                margin-top: 8px;
            }

            .container {
                display: inline-block;
                text-align: left;
                width: 100%;
            }

            .line {
                display: flex;
                align-items: center;
                margin-bottom: 6px;
                gap: 6px;
                justify-content: flex-start;
            }

            .line select {
                width: 60px;
            }

            .line input {
                width: 100px;
                text-align: center;
            }

            .result {
                font-size: 18px;
                margin-top: 8px;
                font-weight: bold;
            }

            .collapse-hidden .collapse-target {
                display: none;
            }

            .small {
                padding: 6px 10px;
                font-size: 14px;
                border-radius: 8px;
            }

            .muted {
                opacity: 0.8;
                font-size: 14px;
            }

            .top-controls {
                display: flex;
                justify-content: center;
                flex-wrap: wrap;
                gap: 8px;
                margin-bottom: 12px;
            }

            #fileNameInput {
                border: 1px solid #aaa;
                border-radius: 8px;
                padding: 6px 8px;
                width: 200px;
            }

            .editable-title {
                cursor: pointer;
                padding: 2px 4px;
                border-radius: 4px;
            }

            .editable-title:hover {
                background-color: rgba(0, 0, 0, 0.1);
            }

            .edit-title-input {
                font-family: inherit;
                font-size: 16px;
                border-radius: 6px;
                border: 1px solid #aaa;
                padding: 2px 4px;
                width: 180px;
            }
        </style>
    </head>
    <body>
        <div class="wrapper">
            <div class="top-controls">
                <input id="fileNameInput" type="text" placeholder="File name (optional)">
                <button id="addCalcBtn">Add Calculation</button>
                <button id="undoBtn">Undo</button>
                <button id="redoBtn">Redo</button>
                <button id="exportAllBtn">Export All CSV</button>
            </div>
            <div class="calculations" id="calculations"></div>
            <div class="muted" style="margin-top:12px"></div>
        </div>
        <script>
            let calculations = [];
            let history = [];
            let redoStack = [];

            function uid() {
                return Math.random().toString(36).slice(2, 9);
            }

            function getCurrentStateObj() {
                return {
                    calculations: calculations.map(calc => ({
                        id: calc.id,
                        customName: calc.customName || '',
                        firstValue: calc.firstInput.value || '',
                        lines: Array.from(calc.lines).map(line => ({
                            operator: line.querySelector('select').value,
                            value: line.querySelector('input').value || ''
                        })),
                        collapsed: calc.element.classList.contains('collapse-hidden')
                    }))
                };
            }

            function pushHistory() {
                const stateStr = JSON.stringify(getCurrentStateObj());
                if (history.length === 0 || history[history.length - 1] !== stateStr) {
                    history.push(stateStr);
                    if (history.length > 200) history.shift();
                }
                localStorage.setItem('mixedOpsState', stateStr);
                redoStack = [];
            }

            function restoreState(stateStr) {
                if (!stateStr) return;
                const data = JSON.parse(stateStr);
                const container = document.getElementById('calculations');
                container.innerHTML = '';
                calculations = [];
                (data.calculations || []).forEach(item => {
                    const calc = createCalculation(item.id, false);
                    calc.firstInput.value = item.firstValue || '';
                    calc.lines.forEach(l => calc.lineContainer.removeChild(l));
                    calc.lines = [];
                    (item.lines || []).forEach(l => {
                        const line = createLine(calc, l.operator, l.value, false);
                        calc.lineContainer.appendChild(line);
                        calc.lines.push(line);
                    });
                    if (item.collapsed) calc.element.classList.add('collapse-hidden');
                    if (item.customName) {
                        calc.customName = item.customName;
                        calc.titleSpan.textContent = item.customName;
                    }
                    evaluateCalculation(calc);
                    container.appendChild(calc.wrapper);
                    calculations.push(calc);
                });
                if (calculations.length === 0) {
                    const calc = createCalculation(undefined, false);
                    container.appendChild(calc.wrapper);
                    calculations.push(calc);
                }
                calculations.forEach(evaluateCalculation);
            }

            function createCalculation(providedId, shouldPushHistory = true) {
                const id = providedId || uid();
                const element = document.createElement('div');
                element.className = 'calc';
                element.dataset.calcId = id;
                const header = document.createElement('div');
                header.className = 'calc-header';
                const titleSpan = document.createElement('span');
                titleSpan.textContent = `calc_${id}`;
                titleSpan.className = 'editable-title';
                let customName = '';
                titleSpan.addEventListener('dblclick', () => {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = titleSpan.textContent;
                    input.className = 'edit-title-input';
                    titleSpan.replaceWith(input);
                    input.focus();
                    input.addEventListener('blur', () => {
                        const newName = input.value.trim();
                        if (newName && newName !== `calc_${id}`) {
                            customName = newName;
                        } else {
                            customName = '';
                        }
                        titleSpan.textContent = customName || `calc_${id}`;
                        input.replaceWith(titleSpan);
                        pushHistory();
                    });
                    input.addEventListener('keydown', e => {
                        if (e.key === 'Enter') input.blur();
                    });
                });
                const resultDiv = document.createElement('div');
                resultDiv.className = 'result';
                header.appendChild(titleSpan);
                header.appendChild(resultDiv);
                const firstValue = document.createElement('input');
                firstValue.type = 'number';
                firstValue.placeholder = 'Enter number';
                const lineContainer = document.createElement('div');
                lineContainer.className = 'container collapse-target';
                const lines = [];
                const collapseBtn = document.createElement('button');
                collapseBtn.textContent = 'Collapse';
                collapseBtn.className = 'small';
                collapseBtn.addEventListener('click', () => {
                    element.classList.toggle('collapse-hidden');
                    pushHistory();
                });
                element.appendChild(header);
                element.appendChild(firstValue);
                element.appendChild(document.createElement('br'));
                element.appendChild(lineContainer);
                const underRow = document.createElement('div');
                underRow.style.marginTop = '8px';
                underRow.appendChild(collapseBtn);
                element.appendChild(underRow);
                const controls = document.createElement('div');
                controls.className = 'calc-controls';
                controls.style.textAlign = 'center';
                controls.style.marginTop = '8px';
                const addLineBtn = document.createElement('button');
                addLineBtn.textContent = 'Add Line';
                addLineBtn.className = 'small';
                addLineBtn.addEventListener('click', () => {
                    const line = createLine(calcObj, '^', '', true);
                    lineContainer.appendChild(line);
                    calcObj.lines.push(line);
                    evaluateCalculation(calcObj);
                    pushHistory();
                });
                const clearBtn = document.createElement('button');
                clearBtn.textContent = 'Clear All';
                clearBtn.className = 'small';
                clearBtn.addEventListener('click', () => {
                    const container = document.getElementById('calculations');
                    if (calculations.length > 0) {
                        const first = calculations[0];
                        container.innerHTML = '';
                        first.firstInput.value = '';
                        first.lineContainer.innerHTML = '';
                        first.lines = [createLine(first, '^', '', false)];
                        first.lineContainer.appendChild(first.lines[0]);
                        evaluateCalculation(first);
                        container.appendChild(first.wrapper);
                        calculations = [first];
                        pushHistory();
                    }
                });
                const removeCalcBtn = document.createElement('button');
                removeCalcBtn.textContent = 'Remove Calculation';
                removeCalcBtn.className = 'small';
                removeCalcBtn.addEventListener('click', () => {
                    const container = document.getElementById('calculations');
                    if (calculations.length === 1) {
                        firstValue.value = '';
                        lineContainer.innerHTML = '';
                        calcObj.lines = [createLine(calcObj, '^', '', false)];
                        lineContainer.appendChild(calcObj.lines[0]);
                        evaluateCalculation(calcObj);
                        pushHistory();
                        return;
                    }
                    container.removeChild(calcObj.wrapper);
                    calculations = calculations.filter(c => c.id !== id);
                    evaluateAll();
                    pushHistory();
                });
                controls.appendChild(addLineBtn);
                controls.appendChild(clearBtn);
                controls.appendChild(removeCalcBtn);
                const calcObj = {
                    id,
                    element,
                    firstInput: firstValue,
                    lineContainer,
                    lines,
                    resultDiv,
                    titleSpan,
                    wrapper: null,
                    controls,
                    customName
                };
                const initialLine = createLine(calcObj, '^', '', false);
                lineContainer.appendChild(initialLine);
                calcObj.lines.push(initialLine);
                firstValue.addEventListener('input', () => {
                    evaluateCalculation(calcObj);
                    pushHistory();
                });
                const wrapper = document.createElement('div');
                wrapper.appendChild(element);
                wrapper.appendChild(controls);
                calcObj.wrapper = wrapper;
                return calcObj;
            }

            function createLine(calc, operatorValue = '*', inputValue = '', shouldPushHistory = true) {
                const line = document.createElement('div');
                line.className = 'line';
                const operator = document.createElement('select');
                ['^', '*', '/', '+', '-'].forEach(op => {
                    const o = document.createElement('option');
                    o.value = op;
                    o.textContent = op;
                    if (op === operatorValue) o.selected = true;
                    operator.appendChild(o);
                });
                const num = document.createElement('input');
                num.type = 'number';
                num.placeholder = 'Value';
                num.value = inputValue;
                const remove = document.createElement('button');
                remove.textContent = 'X';
                remove.className = 'small';
                operator.addEventListener('change', () => {
                    evaluateCalculation(calc);
                    if (shouldPushHistory) pushHistory();
                });
                num.addEventListener('input', () => {
                    evaluateCalculation(calc);
                    if (shouldPushHistory) pushHistory();
                });
                remove.addEventListener('click', () => {
                    const parent = calc.lineContainer;
                    if (parent.contains(line)) parent.removeChild(line);
                    calc.lines = calc.lines.filter(l => l !== line);
                    evaluateCalculation(calc);
                    if (shouldPushHistory) pushHistory();
                });
                line.appendChild(operator);
                line.appendChild(num);
                line.appendChild(remove);
                return line;
            }

            function evaluateCalculation(calc) {
                const firstValue = calc.firstInput.value;
                if (firstValue === '') {
                    calc.resultDiv.textContent = '';
                    return {
                        expression: '',
                        result: ''
                    };
                }
                const ops = calc.lines.map(line => ({
                    op: line.querySelector('select').value,
                    val: line.querySelector('input').value
                })).filter(item => item.val !== '');
                let prev = String(firstValue);
                const parts = [];
                for (let i = 0; i < ops.length; i++) {
                    const {
                        op,
                        val
                    } = ops[i];
                    if (op === '*' || op === '/') {
                        prev = `(${prev}${op}${val})`;
                    } else {
                        parts.push(prev);
                        parts.push(op);
                        prev = String(val);
                    }
                }
                parts.push(prev);
                const expression = parts.join('');
                try {
                    const res = math.evaluate(expression);
                    calc.resultDiv.textContent = `${expression} = ${res}`;
                    return {
                        expression,
                        result: res
                    };
                } catch {
                    calc.resultDiv.textContent = 'Error in expression';
                    return {
                        expression,
                        result: 'Error'
                    };
                }
            }

            function evaluateAll() {
                calculations.forEach(evaluateCalculation);
            }
            document.getElementById('addCalcBtn').addEventListener('click', () => {
                const container = document.getElementById('calculations');
                const calc = createCalculation(undefined, true);
                container.appendChild(calc.wrapper);
                calculations.push(calc);
                evaluateCalculation(calc);
                pushHistory();
            });
            document.getElementById('exportAllBtn').addEventListener('click', () => {
                const rows = [];
                calculations.forEach(calc => {
                    const {
                        expression,
                        result
                    } = evaluateCalculation(calc);
                    if (expression) rows.push([
                        calc.customName || `calc_${calc.id}`,
                        expression,
                        result
                    ]);
                });
                if (rows.length === 0) return;
                let csv = 'Calculation,Expression,Result\n';
                rows.forEach(r => {
                    csv += `"${r[0]}","${r[1]}","${r[2]}"\n`;
                });
                const blob = new Blob([csv], {
                    type: 'text/csv'
                });
                const link = document.createElement('a');
                const inputName = document.getElementById('fileNameInput').value.trim();
                const fileName = inputName || `calculations_${new Date().toISOString().replace(/[:T]/g,'-').slice(0,19)}.csv`;
                link.href = URL.createObjectURL(blob);
                link.download = fileName;
                link.click();
            });

            function undo() {
                if (history.length <= 1) return;
                const current = history.pop();
                redoStack.push(current);
                const prev = history[history.length - 1];
                restoreState(prev);
            }

            function redo() {
                if (redoStack.length === 0) return;
                const state = redoStack.pop();
                history.push(state);
                restoreState(state);
                localStorage.setItem('mixedOpsState', state);
            }
            document.getElementById('undoBtn').addEventListener('click', undo);
            document.getElementById('redoBtn').addEventListener('click', redo);
            document.addEventListener('keydown', e => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                    undo();
                    e.preventDefault();
                } else if ((e.ctrlKey || e.metaKey) && e.key === 'y') {
                    redo();
                    e.preventDefault();
                }
            });
            window.addEventListener('load', () => {
                const saved = localStorage.getItem('mixedOpsState');
                if (saved) {
                    restoreState(saved);
                    history = [saved];
                } else {
                    const container = document.getElementById('calculations');
                    const calc = createCalculation(undefined, false);
                    container.appendChild(calc.wrapper);
                    calculations.push(calc);
                    evaluateCalculation(calc);
                    pushHistory();
                }
            });
        </script>
    </body>
</html>
